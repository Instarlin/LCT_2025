# Frontend компоненты

## Обзор

Frontend системы LCT_2025 построен на React 19 с TypeScript и обеспечивает современный пользовательский интерфейс для анализа медицинских изображений с поддержкой 3D визуализации DICOM данных.

## Технологический стек

### Основные технологии
- **React 19.1.1** - UI библиотека
- **TypeScript 5.8.3** - Типизация
- **Vite (rolldown-vite 7.1.12)** - Сборщик и dev сервер
- **Tailwind CSS 4.1.13** - Стилизация

### Специализированные библиотеки
- **@cornerstonejs/core** - 3D визуализация медицинских изображений
- **@cornerstonejs/dicom-image-loader** - Загрузка DICOM файлов
- **@cornerstonejs/nifti-volume-loader** - Загрузка NIfTI томов
- **@cornerstonejs/tools** - Инструменты для работы с изображениями

### UI компоненты
- **@radix-ui/react-*** - Примитивные UI компоненты
- **lucide-react** - Иконки
- **motion** - Анимации
- **sonner** - Уведомления

### State Management
- **Zustand** - Управление состоянием
- **React Router 7** - Маршрутизация

## Структура проекта

```
frontend/src/
├── app.tsx                 # Главный компонент приложения
├── app.css                 # Глобальные стили
├── main.tsx                # Точка входа
├── components/             # UI компоненты
│   └── ui/                # Базовые UI компоненты
├── features/              # Функциональные модули
│   ├── auth/              # Аутентификация
│   ├── upload/            # Загрузка файлов
│   ├── history/           # История заданий
│   └── job/               # Работа с заданиями
├── lib/                   # Утилиты и хелперы
│   ├── dicom/             # DICOM обработка
│   ├── storage/           # State management
│   └── styles/            # Стили
└── types/                 # TypeScript типы
    └── workspace.ts       # Типы рабочего пространства
```

## Основные компоненты

### 1. app.tsx - Главный компонент

**Функции:**
- Управление состоянием всего приложения
- Обработка аутентификации
- Управление заданиями и файлами
- WebSocket соединения
- DICOM обработка

**Ключевые хуки:**
- `useWorkspaceController()` - Основная логика приложения
- `useAuthStore()` - Состояние аутентификации
- `useJobsStore()` - Состояние заданий
- `useViewerStore()` - Состояние просмотрщика

### 2. Аутентификация (features/auth/)

**Компоненты:**
- `AuthPage` - Страница входа/регистрации
- Формы входа и регистрации
- Обработка JWT токенов

**State Management:**
- `useAuthStore` - Zustand store для аутентификации
- Сохранение токенов в localStorage
- Автоматический logout при истечении токена

### 3. Загрузка файлов (features/upload/)

**Компоненты:**
- `UploadLanding` - Главная страница загрузки
- Drag & Drop интерфейс
- Прогресс загрузки
- Валидация файлов

**Поддерживаемые форматы:**
- `.dcm` - DICOM файлы
- `.zip` - ZIP архивы с DICOM файлами

**Функции:**
- Загрузка через XMLHttpRequest с прогрессом
- Отмена загрузки
- Валидация размера и типа файлов

### 4. История заданий (features/history/)

**Компоненты:**
- `HistorySidebar` - Боковая панель с историей
- Фильтрация по патологиям
- Поиск по заданиям
- Сортировка и группировка

**Функции:**
- Отображение списка заданий
- Фильтрация по статусу и дате
- Поиск по названию и описанию
- Выбор активного задания

### 5. Работа с заданиями (features/job/)

**Компоненты:**
- `JobWorkspace` - Рабочее пространство задания
- 3D просмотрщик изображений
- Таблица сегментации
- Результаты анализа

**Функции:**
- 3D визуализация DICOM данных
- Управление сегментами
- Экспорт результатов
- Real-time обновления статуса

## State Management

### 1. useAuthStore - Аутентификация
```typescript
interface AuthState {
  isAuthenticated: boolean
  username: string | null
  token: string | null
  login: (username: string, token: string) => void
  logout: () => void
}
```

### 2. useJobsStore - Задания
```typescript
interface JobsState {
  items: HistoryItem[]
  loading: boolean
  error: string | null
  hasFetched: boolean
  fetchJobs: (token?: string) => Promise<void>
  addJob: (job: HistoryItem) => void
  updateJob: (id: string, updates: Partial<HistoryItem>) => void
  removeJob: (id: string) => void
}
```

### 3. useViewerStore - Просмотрщик
```typescript
interface ViewerState {
  fullscreen: boolean
  setFullscreen: (value: boolean) => void
  reset: () => void
}
```

## DICOM обработка

### 1. Извлечение DICOM файлов
- Автоматическое извлечение из ZIP архивов
- Валидация DICOM заголовков
- Обработка метаданных

### 2. 3D визуализация
- Использование Cornerstone.js
- Поддержка различных проекций
- Инструменты для измерения и аннотации

### 3. Сегментация
- Отображение результатов ML анализа
- Управление сегментами
- Цветовое кодирование

## WebSocket интеграция

### 1. Real-time обновления
- Подключение к `/ws/jobs/{job_id}`
- Автоматическое переподключение
- Обработка обновлений статуса заданий

### 2. Управление соединениями
- Автоматическое закрытие при завершении задания
- Retry логика при обрыве соединения
- Graceful shutdown

## API интеграция

### 1. REST API
- Все запросы через `/api` прокси
- Автоматическое добавление JWT токенов
- Обработка ошибок и retry логика

### 2. Загрузка файлов
- XMLHttpRequest для отслеживания прогресса
- Поддержка отмены загрузки
- Валидация ответов

### 3. Получение результатов
- Кэширование результатов
- Автоматическое обновление при изменениях
- Обработка больших файлов

## UI/UX особенности

### 1. Адаптивный дизайн
- Поддержка мобильных устройств
- Адаптивная боковая панель
- Responsive 3D просмотрщик

### 2. Accessibility
- Поддержка клавиатурной навигации
- ARIA атрибуты
- Семантическая разметка

### 3. Производительность
- Lazy loading компонентов
- Виртуализация больших списков
- Оптимизация re-renders

## Конфигурация

### 1. Vite конфигурация
```typescript
export default defineConfig({
  plugins: [react(), tailwindcss(), viteCommonjs()],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
  optimizeDeps: {
    exclude: ['@cornerstonejs/dicom-image-loader'],
    include: ['dicom-parser'], 
  },
  server: {
    port: 5173,
    host: true,
    proxy: {
      '/api': {
        target: process.env.VITE_BACKEND_URL ?? 'http://localhost:8000',
        rewrite: (p) => p.replace(/^\/api/, ''),
        ws: true,
      },
    },
  },
})
```

### 2. Переменные окружения
- `VITE_BACKEND_URL` - URL backend API
- `NODE_ENV` - Режим разработки/production

### 3. TypeScript конфигурация
- Строгая типизация
- Path mapping для импортов
- Совместимость с React 19

## Обработка ошибок

### 1. Сетевые ошибки
- Retry логика для API запросов
- Graceful degradation при недоступности сервисов
- Пользовательские сообщения об ошибках

### 2. Ошибки загрузки файлов
- Валидация перед загрузкой
- Отмена загрузки при ошибках
- Восстановление после ошибок

### 3. DICOM ошибки
- Валидация файлов перед обработкой
- Fallback для некорректных файлов
- Информативные сообщения об ошибках

## Производительность

### 1. Оптимизация загрузки
- Code splitting по маршрутам
- Lazy loading тяжелых компонентов
- Оптимизация bundle размера

### 2. Оптимизация рендеринга
- React.memo для компонентов
- useMemo и useCallback для вычислений
- Виртуализация для больших списков

### 3. Оптимизация памяти
- Очистка ресурсов при размонтировании
- Управление WebSocket соединениями
- Очистка DICOM кэша

## Тестирование

### 1. Unit тесты
- Тестирование утилит и хелперов
- Тестирование state management
- Тестирование API интеграции

### 2. Integration тесты
- Тестирование компонентов с реальными данными
- Тестирование WebSocket соединений
- Тестирование DICOM обработки

### 3. E2E тесты
- Полный цикл загрузки и анализа
- Тестирование пользовательских сценариев
- Тестирование на разных устройствах
